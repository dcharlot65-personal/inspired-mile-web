---
import WalletButton from '../components/WalletButton';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
}

const { title, description = 'Inspired Mile — Digital Collectible Cards Powered by AI and AR', ogImage = '/images/cards/sm-001.webp' } = Astro.props;
const currentPath = Astro.url.pathname;
const canonicalUrl = `https://sonnetman.inspiredmile.com${currentPath}`;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#D4A017" />
    <meta name="color-scheme" content="dark" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preload" href="/fonts/inter-latin.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" sizes="32x32" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:title" content={`${title} | Inspired Mile`} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImage} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${title} | Inspired Mile`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <title>{title} | Inspired Mile</title>
    <script is:inline src="https://accounts.google.com/gsi/client" async defer></script>
    <script is:inline defer data-domain="inspiredmile.com" src="https://plausible.io/js/script.js"></script>
    <script is:inline type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Inspired Mile",
      "alternateName": "Sonnet Man",
      "url": "https://sonnetman.inspiredmile.com",
      "description": "Shakespeare-themed collectible card game with AI-judged poetry battles, classroom mode, and multiplayer arena.",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Inspired Mile"
      },
      "genre": ["Educational", "Card Game", "Literature"],
      "audience": {
        "@type": "EducationalAudience",
        "educationalRole": "student",
        "suggestedMinAge": 13
      }
    }
    </script>
  </head>
  <body class="min-h-screen flex flex-col">
    <!-- Age Gate Modal -->
    <div id="age-gate" class="fixed inset-0 z-[200] bg-obsidian-950 flex items-center justify-center p-4 hidden">
      <div class="card-glass max-w-md w-full p-8 text-center bg-obsidian-900/95 backdrop-blur-xl border border-obsidian-700 rounded-2xl shadow-2xl">
        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-gold-400 to-gold-600 flex items-center justify-center mx-auto mb-6">
          <span class="text-obsidian-950 font-display font-bold text-2xl">IM</span>
        </div>
        <h2 class="font-display text-2xl font-bold text-white mb-2">Welcome to Inspired Mile</h2>
        <p class="text-obsidian-400 text-sm mb-6">Please confirm your age to continue.</p>

        <div id="age-gate-form">
          <label class="block text-left text-xs text-obsidian-400 mb-2">Date of Birth</label>
          <div class="flex gap-2 mb-4">
            <select id="age-month" class="flex-1 bg-obsidian-800 border border-obsidian-700 rounded-lg px-3 py-2.5 text-sm text-obsidian-200 focus:border-gold-500/50 focus:outline-none">
              <option value="">Month</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <select id="age-day" class="w-20 bg-obsidian-800 border border-obsidian-700 rounded-lg px-3 py-2.5 text-sm text-obsidian-200 focus:border-gold-500/50 focus:outline-none">
              <option value="">Day</option>
            </select>
            <select id="age-year" class="w-24 bg-obsidian-800 border border-obsidian-700 rounded-lg px-3 py-2.5 text-sm text-obsidian-200 focus:border-gold-500/50 focus:outline-none">
              <option value="">Year</option>
            </select>
          </div>
          <button id="age-gate-submit" class="btn-primary w-full py-3 font-display font-bold">Continue</button>
          <p id="age-gate-error" class="text-crimson-400 text-xs mt-3 hidden"></p>
        </div>

        <div id="age-gate-minor" class="hidden">
          <div class="w-12 h-12 rounded-full bg-crimson-500/20 border border-crimson-500/30 flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-crimson-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
          </div>
          <h3 class="font-display text-lg font-bold text-crimson-400 mb-2">Age Requirement Not Met</h3>
          <p class="text-obsidian-400 text-sm">
            You must be at least 13 years old to use Inspired Mile. Please come back when you meet the age requirement.
          </p>
        </div>

        <div id="age-gate-teen" class="hidden">
          <div class="w-12 h-12 rounded-full bg-gold-500/20 border border-gold-500/30 flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-gold-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <h3 class="font-display text-lg font-bold text-gold-400 mb-2">Parental Consent Required</h3>
          <p class="text-obsidian-400 text-sm mb-4">
            Since you are under 18, you need parental or guardian consent to use Inspired Mile.
          </p>
          <label class="flex items-start gap-3 text-left mb-4 cursor-pointer">
            <input type="checkbox" id="parental-consent" class="mt-1 w-4 h-4 rounded border-obsidian-600 bg-obsidian-800 text-gold-500 focus:ring-gold-500/50" />
            <span class="text-xs text-obsidian-300 leading-relaxed">
              I confirm that my parent or legal guardian has reviewed the
              <a href="/terms" class="text-gold-400 hover:text-gold-300">Terms of Service</a> and
              <a href="/privacy" class="text-gold-400 hover:text-gold-300">Privacy Policy</a>
              and consents to my use of Inspired Mile.
            </span>
          </label>
          <button id="teen-continue" class="btn-primary w-full py-3 font-display font-bold opacity-50 pointer-events-none">Continue with Consent</button>
        </div>

        <p class="text-[10px] text-obsidian-600 mt-6">
          By continuing, you agree to our <a href="/terms" class="text-obsidian-500 hover:text-gold-400">Terms of Service</a> and <a href="/privacy" class="text-obsidian-500 hover:text-gold-400">Privacy Policy</a>.
        </p>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 bg-obsidian-950/80 backdrop-blur-lg border-b border-obsidian-800/50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo -->
          <a href="/" class="flex items-center gap-3 group">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-gold-400 to-gold-600 flex items-center justify-center">
              <span class="text-obsidian-950 font-display font-bold text-sm">IM</span>
            </div>
            <span class="font-display text-lg font-semibold text-gold-400 group-hover:text-gold-300 transition-colors">
              Inspired Mile
            </span>
          </a>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center gap-6">
            <a href="/" class:list={["text-sm font-medium transition-colors", currentPath === "/" ? "text-gold-400" : "text-obsidian-300 hover:text-gold-400"]}>
              Home
            </a>
            <a href="/collection" class:list={["text-sm font-medium transition-colors", currentPath === "/collection" ? "text-gold-400" : "text-obsidian-300 hover:text-gold-400"]}>
              Collection
            </a>
            <!-- Play dropdown -->
            <div class="relative group">
              <button class:list={["text-sm font-medium transition-colors flex items-center gap-1", ["/playground","/battle","/multiplayer","/tournaments"].includes(currentPath) ? "text-gold-400" : "text-obsidian-300 hover:text-gold-400"]}>
                Play
                <svg class="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div class="absolute left-1/2 -translate-x-1/2 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150">
                <div class="w-44 bg-obsidian-900/95 backdrop-blur-lg border border-obsidian-700 rounded-xl shadow-2xl py-2">
                  <a href="/playground" class:list={["block px-4 py-2 text-sm transition-colors", currentPath === "/playground" ? "text-gold-400 bg-gold-500/5" : "text-obsidian-300 hover:text-gold-400 hover:bg-obsidian-800/50"]}>Playground</a>
                  <a href="/battle" class:list={["block px-4 py-2 text-sm transition-colors", currentPath === "/battle" ? "text-gold-400 bg-gold-500/5" : "text-obsidian-300 hover:text-gold-400 hover:bg-obsidian-800/50"]}>Battle Arena</a>
                  <a href="/multiplayer" class:list={["block px-4 py-2 text-sm transition-colors", currentPath === "/multiplayer" ? "text-gold-400 bg-gold-500/5" : "text-obsidian-300 hover:text-gold-400 hover:bg-obsidian-800/50"]}>Multiplayer</a>
                  <a href="/tournaments" class:list={["block px-4 py-2 text-sm transition-colors", currentPath === "/tournaments" ? "text-gold-400 bg-gold-500/5" : "text-obsidian-300 hover:text-gold-400 hover:bg-obsidian-800/50"]}>Tournaments</a>
                </div>
              </div>
            </div>
            <!-- Explore dropdown -->
            <div class="relative group">
              <button class:list={["text-sm font-medium transition-colors flex items-center gap-1", ["/world-map","/marketplace","/vr","/viewer"].includes(currentPath) ? "text-gold-400" : "text-obsidian-300 hover:text-gold-400"]}>
                Explore
                <svg class="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div class="absolute left-1/2 -translate-x-1/2 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150">
                <div class="w-44 bg-obsidian-900/95 backdrop-blur-lg border border-obsidian-700 rounded-xl shadow-2xl py-2">
                  <a href="/world-map" class:list={["block px-4 py-2 text-sm transition-colors", currentPath === "/world-map" ? "text-gold-400 bg-gold-500/5" : "text-obsidian-300 hover:text-gold-400 hover:bg-obsidian-800/50"]}>World Map</a>
                  <a href="/marketplace" class:list={["block px-4 py-2 text-sm transition-colors", currentPath === "/marketplace" ? "text-gold-400 bg-gold-500/5" : "text-obsidian-300 hover:text-gold-400 hover:bg-obsidian-800/50"]}>Marketplace</a>
                  <a href="/vr" class:list={["block px-4 py-2 text-sm transition-colors", currentPath === "/vr" ? "text-gold-400 bg-gold-500/5" : "text-obsidian-300 hover:text-gold-400 hover:bg-obsidian-800/50"]}>VR Gallery</a>
                  <a href="/viewer" class:list={["block px-4 py-2 text-sm transition-colors", currentPath === "/viewer" ? "text-gold-400 bg-gold-500/5" : "text-obsidian-300 hover:text-gold-400 hover:bg-obsidian-800/50"]}>3D Viewer</a>
                </div>
              </div>
            </div>
            <a href="/about" class:list={["text-sm font-medium transition-colors", currentPath === "/about" ? "text-gold-400" : "text-obsidian-300 hover:text-gold-400"]}>
              About
            </a>
            <a href="/profile" class:list={["text-sm font-medium transition-colors", currentPath === "/profile" ? "text-gold-400" : "text-obsidian-300 hover:text-gold-400"]}>
              Profile
            </a>
          </div>

          <!-- Wallet + Auth + Audio toggle + Mobile menu button -->
          <div class="flex items-center gap-2">
            <!-- Solana Wallet -->
            <div class="hidden md:block">
              <WalletButton client:load />
            </div>
            <!-- Auth: Login/User button -->
            <div id="auth-container" class="relative">
              <button id="auth-btn" class="text-xs font-medium text-obsidian-300 hover:text-gold-400 transition-colors border border-obsidian-700 rounded-lg px-3 py-1.5 hover:border-gold-500/30">
                Sign In
              </button>
              <div id="user-badge" class="hidden flex items-center gap-2 cursor-pointer">
                <div class="w-7 h-7 rounded-full bg-gold-500/20 border border-gold-500/30 flex items-center justify-center">
                  <span id="user-initial" class="text-xs font-bold text-gold-400">?</span>
                </div>
                <span id="user-name" class="hidden md:inline text-xs font-medium text-obsidian-300"></span>
              </div>
              <!-- Auth dropdown -->
              <div id="auth-dropdown" class="hidden absolute right-0 top-full mt-2 w-72 card-glass bg-obsidian-900/95 backdrop-blur-lg border border-obsidian-700 rounded-xl shadow-2xl z-50 p-4">
                <!-- Sign-in options (when not logged in) -->
                <div id="auth-sign-in-options">
                  <h3 class="text-sm font-display font-bold text-obsidian-200 mb-3">Sign In</h3>
                  <button id="google-sign-in-btn" class="w-full flex items-center justify-center gap-2 bg-white text-gray-700 rounded-lg px-3 py-2.5 text-xs font-medium hover:bg-gray-50 transition-colors mb-2">
                    <svg class="w-4 h-4" viewBox="0 0 24 24">
                      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/>
                      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                  </button>
                  <div class="flex items-center gap-2 my-3">
                    <div class="flex-1 h-px bg-obsidian-700"></div>
                    <span class="text-[10px] text-obsidian-500 uppercase">or</span>
                    <div class="flex-1 h-px bg-obsidian-700"></div>
                  </div>
                  <button id="wallet-sign-in-btn" class="w-full flex items-center justify-center gap-2 border border-gold-500/30 text-gold-400 rounded-lg px-3 py-2.5 text-xs font-medium hover:bg-gold-500/10 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    Sign in with Wallet
                  </button>
                  <p id="auth-error" class="hidden text-xs text-crimson-400 mt-2 text-center"></p>
                  <p class="text-[10px] text-obsidian-600 mt-3 text-center leading-relaxed">
                    By signing in, you agree to our <a href="/terms" class="text-obsidian-400 hover:text-gold-400">Terms of Service</a> and <a href="/privacy" class="text-obsidian-400 hover:text-gold-400">Privacy Policy</a>.
                  </p>
                </div>
                <!-- User menu (when logged in) -->
                <div id="auth-user-menu" class="hidden">
                  <div class="flex items-center gap-3 mb-3 pb-3 border-b border-obsidian-700">
                    <div class="w-10 h-10 rounded-full bg-gold-500/20 border border-gold-500/30 flex items-center justify-center">
                      <span id="menu-user-initial" class="text-lg font-bold text-gold-400">?</span>
                    </div>
                    <div>
                      <p id="menu-user-name" class="text-sm font-semibold text-obsidian-200"></p>
                      <p id="menu-user-provider" class="text-xs text-emerald-400">Synced to server</p>
                    </div>
                  </div>
                  <a href="/profile" class="block text-xs text-obsidian-400 hover:text-gold-400 py-2 text-center transition-colors">
                    View Profile
                  </a>
                  <button id="auth-logout-btn" class="w-full text-xs text-obsidian-400 hover:text-crimson-400 py-2 text-center transition-colors">
                    Sign Out
                  </button>
                </div>
              </div>
            </div>
            <button id="audio-toggle" class="text-obsidian-400 hover:text-gold-400 transition-colors p-2 rounded-lg hover:bg-obsidian-800/50" aria-label="Toggle audio" title="Toggle audio">
              <svg id="audio-icon-on" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
              </svg>
              <svg id="audio-icon-off" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
              </svg>
            </button>
          <button id="mobile-menu-btn" class="md:hidden text-obsidian-300 hover:text-gold-400 transition-colors" aria-label="Toggle menu">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          </div>
        </div>
      </div>

      <!-- Mobile menu -->
      <div id="mobile-menu" class="hidden md:hidden border-t border-obsidian-800/50 bg-obsidian-950/95 backdrop-blur-lg">
        <div class="px-4 py-4 space-y-1">
          <a href="/" class:list={["block text-sm font-medium py-2", currentPath === "/" ? "text-gold-400" : "text-obsidian-300"]}>Home</a>
          <a href="/collection" class:list={["block text-sm font-medium py-2", currentPath === "/collection" ? "text-gold-400" : "text-obsidian-300"]}>Collection</a>
          <div class="pt-2 pb-1"><span class="text-[10px] font-mono text-obsidian-600 uppercase tracking-widest">Play</span></div>
          <a href="/playground" class:list={["block text-sm font-medium py-2 pl-3", currentPath === "/playground" ? "text-gold-400" : "text-obsidian-300"]}>Playground</a>
          <a href="/battle" class:list={["block text-sm font-medium py-2 pl-3", currentPath === "/battle" ? "text-gold-400" : "text-obsidian-300"]}>Battle Arena</a>
          <a href="/multiplayer" class:list={["block text-sm font-medium py-2 pl-3", currentPath === "/multiplayer" ? "text-gold-400" : "text-obsidian-300"]}>Multiplayer</a>
          <a href="/tournaments" class:list={["block text-sm font-medium py-2 pl-3", currentPath === "/tournaments" ? "text-gold-400" : "text-obsidian-300"]}>Tournaments</a>
          <div class="pt-2 pb-1"><span class="text-[10px] font-mono text-obsidian-600 uppercase tracking-widest">Explore</span></div>
          <a href="/world-map" class:list={["block text-sm font-medium py-2 pl-3", currentPath === "/world-map" ? "text-gold-400" : "text-obsidian-300"]}>World Map</a>
          <a href="/marketplace" class:list={["block text-sm font-medium py-2 pl-3", currentPath === "/marketplace" ? "text-gold-400" : "text-obsidian-300"]}>Marketplace</a>
          <a href="/vr" class:list={["block text-sm font-medium py-2 pl-3", currentPath === "/vr" ? "text-gold-400" : "text-obsidian-300"]}>VR Gallery</a>
          <a href="/viewer" class:list={["block text-sm font-medium py-2 pl-3", currentPath === "/viewer" ? "text-gold-400" : "text-obsidian-300"]}>3D Viewer</a>
          <div class="border-t border-obsidian-800/50 mt-2 pt-2">
            <a href="/about" class:list={["block text-sm font-medium py-2", currentPath === "/about" ? "text-gold-400" : "text-obsidian-300"]}>About</a>
            <a href="/profile" class:list={["block text-sm font-medium py-2", currentPath === "/profile" ? "text-gold-400" : "text-obsidian-300"]}>Profile</a>
            <button id="mobile-auth-btn" class="block text-sm font-medium py-2 text-gold-400">Sign In</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Achievement Toast Container -->
    <div id="achievement-toasts" class="fixed top-20 right-4 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <!-- Data Migration Banner -->
    <div id="migration-banner" class="hidden fixed top-20 left-1/2 -translate-x-1/2 z-[90] card-glass p-4 max-w-md bg-obsidian-900/95 backdrop-blur-lg border-gold-500/30 shadow-2xl rounded-xl">
      <h4 class="text-sm font-display font-bold text-gold-300 mb-1">Sync Your Data?</h4>
      <p class="text-xs text-obsidian-400 mb-3">We found local game progress. Sync it to your account so it's saved across devices.</p>
      <div class="flex gap-2">
        <button id="migrate-yes" class="btn-primary text-xs px-4 py-1.5">Sync Data</button>
        <button id="migrate-no" class="btn-secondary text-xs px-4 py-1.5">Skip</button>
      </div>
      <p id="migration-result" class="hidden text-xs mt-2"></p>
    </div>

    <!-- Main Content -->
    <main class="flex-1 pt-16">
      <slot />
    </main>

    <!-- Footer -->
    <footer class="border-t border-obsidian-800/50 bg-obsidian-950">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div>
            <div class="flex items-center gap-3 mb-4">
              <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-gold-400 to-gold-600 flex items-center justify-center">
                <span class="text-obsidian-950 font-display font-bold text-sm">IM</span>
              </div>
              <span class="font-display text-lg font-semibold text-gold-400">Inspired Mile</span>
            </div>
            <p class="text-obsidian-400 text-sm leading-relaxed">
              Digital collectible cards powered by AI and augmented reality. Interactive experiences that bring Shakespeare to life.
            </p>
          </div>
          <div>
            <h4 class="font-display text-sm font-semibold text-obsidian-200 mb-4">Platform</h4>
            <ul class="space-y-2 text-sm text-obsidian-400">
              <li><a href="/collection" class="hover:text-gold-400 transition-colors">Card Collection</a></li>
              <li><a href="/playground" class="hover:text-gold-400 transition-colors">Playground</a></li>
              <li><a href="/battle" class="hover:text-gold-400 transition-colors">Battle Arena</a></li>
              <li><a href="/multiplayer" class="hover:text-gold-400 transition-colors">Multiplayer</a></li>
              <li><a href="/marketplace" class="hover:text-gold-400 transition-colors">Marketplace</a></li>
              <li><a href="/tournaments" class="hover:text-gold-400 transition-colors">Tournaments</a></li>
              <li><a href="/world-map" class="hover:text-gold-400 transition-colors">World Map</a></li>
              <li><a href="/profile" class="hover:text-gold-400 transition-colors">Profile</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-display text-sm font-semibold text-obsidian-200 mb-4">Company</h4>
            <ul class="space-y-2 text-sm text-obsidian-400">
              <li><a href="/about" class="hover:text-gold-400 transition-colors">About Us</a></li>
              <li><a href="https://sonnetman.com" target="_blank" rel="noopener noreferrer" class="hover:text-gold-400 transition-colors">The Sonnet Man</a></li>
              <li><a href="/privacy" class="hover:text-gold-400 transition-colors">Privacy Policy</a></li>
              <li><a href="/terms" class="hover:text-gold-400 transition-colors">Terms of Service</a></li>
            </ul>
            <div class="flex items-center gap-3 mt-4">
              <a href="https://www.youtube.com/TheSonnetManTV" target="_blank" rel="noopener noreferrer" class="text-obsidian-500 hover:text-gold-400 transition-colors" aria-label="YouTube">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
              </a>
              <a href="https://x.com/thesonnetmannyc" target="_blank" rel="noopener noreferrer" class="text-obsidian-500 hover:text-gold-400 transition-colors" aria-label="X / Twitter">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              </a>
              <a href="https://www.linkedin.com/in/thesonnetman/" target="_blank" rel="noopener noreferrer" class="text-obsidian-500 hover:text-gold-400 transition-colors" aria-label="LinkedIn">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
              </a>
              <a href="https://www.facebook.com/TheSonnetMan/" target="_blank" rel="noopener noreferrer" class="text-obsidian-500 hover:text-gold-400 transition-colors" aria-label="Facebook">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
              </a>
            </div>
          </div>
        </div>
        <div class="mt-8 pt-8 border-t border-obsidian-800/50 text-center text-obsidian-500 text-xs">
          <p>&copy; {new Date().getFullYear()} Voyage Tracable, LLC (DBA Inspired Mile). All rights reserved. Sarasota, FL.</p>
          <p class="mt-1">
            <a href="/privacy" class="hover:text-gold-400 transition-colors">Privacy Policy</a>
            <span class="mx-1">&middot;</span>
            <a href="/terms" class="hover:text-gold-400 transition-colors">Terms of Service</a>
          </p>
        </div>
      </div>
    </footer>

    <script>
      import { initAudio, toggleMute, getPrefs, isInitialized, stopMusic } from '../lib/audio-manager';

      // Fade out music when navigating away for smoother transitions
      window.addEventListener('beforeunload', () => {
        stopMusic(200);
      });

      // Mobile menu toggle
      const btn = document.getElementById('mobile-menu-btn');
      const menu = document.getElementById('mobile-menu');
      btn?.addEventListener('click', () => {
        menu?.classList.toggle('hidden');
      });

      // Audio toggle
      const audioToggle = document.getElementById('audio-toggle');
      const iconOn = document.getElementById('audio-icon-on');
      const iconOff = document.getElementById('audio-icon-off');

      function updateAudioIcon() {
        const p = getPrefs();
        if (p.muted) {
          iconOn?.classList.add('hidden');
          iconOff?.classList.remove('hidden');
        } else {
          iconOn?.classList.remove('hidden');
          iconOff?.classList.add('hidden');
        }
      }
      updateAudioIcon();

      // Init AudioContext on first user interaction (autoplay policy)
      document.addEventListener('click', () => {
        if (!isInitialized()) initAudio();
      }, { once: true });

      // Fade music out on internal navigation for smoother transitions
      document.querySelectorAll('a[href^="/"]').forEach(link => {
        link.addEventListener('click', () => {
          if (isInitialized()) stopMusic(300);
        });
      });

      audioToggle?.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!isInitialized()) initAudio();
        toggleMute();
        updateAudioIcon();
      });
    </script>

    <script>
      // ---- Toast notification system ----
      type ToastType = 'success' | 'error' | 'info' | 'warning';

      const TOAST_STYLES: Record<ToastType, string> = {
        success: 'bg-emerald-500/15 border-emerald-500/40 text-emerald-300',
        error: 'bg-crimson-500/15 border-crimson-500/40 text-crimson-300',
        info: 'bg-purple-500/15 border-purple-500/40 text-purple-300',
        warning: 'bg-gold-500/15 border-gold-500/40 text-gold-300',
      };

      const TOAST_ICONS: Record<ToastType, string> = {
        success: '\u2713',
        error: '\u2717',
        info: '\u24D8',
        warning: '\u26A0',
      };

      function showToast(message: string, type: ToastType = 'info', duration = 4000) {
        const container = document.getElementById('achievement-toasts');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl border backdrop-blur-lg shadow-2xl transform translate-x-full opacity-0 transition-all duration-500 max-w-sm ${TOAST_STYLES[type]}`;
        toast.innerHTML = `
          <span class="text-lg font-bold">${TOAST_ICONS[type]}</span>
          <p class="text-sm flex-1">${message}</p>
        `;
        container.appendChild(toast);

        requestAnimationFrame(() => {
          toast.classList.remove('translate-x-full', 'opacity-0');
          toast.classList.add('translate-x-0', 'opacity-100');
        });

        setTimeout(() => {
          toast.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => toast.remove(), 500);
        }, duration);
      }

      // Expose globally so page scripts can use it
      (window as any).showToast = showToast;

      // ---- Achievement toast notifications ----
      const TIER_COLORS: Record<string, string> = {
        bronze: 'from-amber-700 to-amber-900 border-amber-600',
        silver: 'from-gray-400 to-gray-600 border-gray-300',
        gold: 'from-gold-400 to-gold-600 border-gold-300',
      };

      window.addEventListener('achievement-unlocked', ((e: CustomEvent) => {
        const a = e.detail;
        const container = document.getElementById('achievement-toasts');
        if (!container) return;

        const toast = document.createElement('div');
        const colors = TIER_COLORS[a.tier] || TIER_COLORS.bronze;
        toast.className = `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl bg-gradient-to-r ${colors} border shadow-2xl transform translate-x-full opacity-0 transition-all duration-500 max-w-sm`;
        toast.innerHTML = `
          <span class="text-2xl">${a.icon}</span>
          <div class="flex-1 min-w-0">
            <div class="text-xs font-semibold uppercase tracking-wider text-white/70">Achievement Unlocked</div>
            <div class="font-display font-bold text-white truncate">${a.name}</div>
            <div class="text-xs text-white/80">${a.description}</div>
          </div>
        `;
        container.appendChild(toast);

        requestAnimationFrame(() => {
          toast.classList.remove('translate-x-full', 'opacity-0');
          toast.classList.add('translate-x-0', 'opacity-100');
        });

        setTimeout(() => {
          toast.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => toast.remove(), 500);
        }, 4000);
      }) as EventListener);
    </script>

    <script>
      // Auth UI logic — Google OAuth + Solana Wallet sign-in
      import { initStorageBackend, isLoggedIn, getCurrentUser, googleSignInUser, walletSignInUser, logoutUser } from '../lib/storage-backend';
      import { requestWalletNonce, getMigrationStatus, syncMigration, type MigrationPayload } from '../lib/api-client';
      import { getWalletAddress, isConnected as isWalletConnected, signAuthMessage } from '../lib/wallet';
      import { getPlayerStats } from '../lib/achievements';

      const authBtn = document.getElementById('auth-btn')!;
      const userBadge = document.getElementById('user-badge')!;
      const authDropdown = document.getElementById('auth-dropdown')!;
      const signInOptions = document.getElementById('auth-sign-in-options')!;
      const userMenu = document.getElementById('auth-user-menu')!;
      const authError = document.getElementById('auth-error')!;

      function showError(msg: string) {
        authError.textContent = msg;
        authError.classList.remove('hidden');
      }
      function clearError() {
        authError.classList.add('hidden');
      }

      function updateAuthUI() {
        clearError();
        const mobileAuthBtn = document.getElementById('mobile-auth-btn');
        if (isLoggedIn()) {
          const user = getCurrentUser()!;
          const initial = (user.display_name || user.username)[0].toUpperCase();
          authBtn.classList.add('hidden');
          if (mobileAuthBtn) mobileAuthBtn.classList.add('hidden');
          userBadge.classList.remove('hidden');
          userBadge.classList.add('flex');
          document.getElementById('user-initial')!.textContent = initial;
          document.getElementById('user-name')!.textContent = user.display_name || user.username;
          document.getElementById('menu-user-initial')!.textContent = initial;
          document.getElementById('menu-user-name')!.textContent = user.display_name || user.username;
          const providerEl = document.getElementById('menu-user-provider')!;
          providerEl.textContent = user.auth_provider === 'google' ? 'Signed in with Google' : 'Signed in with Wallet';
          signInOptions.classList.add('hidden');
          userMenu.classList.remove('hidden');
        } else {
          authBtn.classList.remove('hidden');
          if (mobileAuthBtn) mobileAuthBtn.classList.remove('hidden');
          userBadge.classList.add('hidden');
          signInOptions.classList.remove('hidden');
          userMenu.classList.add('hidden');
        }
      }

      // Toggle dropdown
      function toggleDropdown() {
        authDropdown.classList.toggle('hidden');
      }
      authBtn.addEventListener('click', toggleDropdown);
      userBadge.addEventListener('click', toggleDropdown);
      document.getElementById('mobile-auth-btn')?.addEventListener('click', toggleDropdown);

      // Close on outside click
      document.addEventListener('click', (e) => {
        const container = document.getElementById('auth-container')!;
        if (!container.contains(e.target as Node)) {
          authDropdown.classList.add('hidden');
        }
      });

      // --- Google Sign-In ---
      function initGoogleSignIn() {
        const clientId = import.meta.env.PUBLIC_GOOGLE_CLIENT_ID;
        if (!clientId || typeof google === 'undefined') return;
        google.accounts.id.initialize({
          client_id: clientId,
          callback: handleGoogleCredential,
        });
      }

      async function handleGoogleCredential(response: { credential: string }) {
        clearError();
        try {
          await googleSignInUser(response.credential);
          updateAuthUI();
          authDropdown.classList.add('hidden');
          syncAgeTier();
          offerMigrationIfNeeded();
        } catch (e: any) {
          showError(e.body || e.message || 'Google sign-in failed');
        }
      }

      document.getElementById('google-sign-in-btn')?.addEventListener('click', () => {
        clearError();
        const clientId = import.meta.env.PUBLIC_GOOGLE_CLIENT_ID;
        if (!clientId) {
          showError('Google sign-in not configured');
          return;
        }
        if (typeof google === 'undefined') {
          showError('Google script not loaded yet. Please try again.');
          return;
        }
        google.accounts.id.prompt();
      });

      // --- Wallet Sign-In ---
      document.getElementById('wallet-sign-in-btn')?.addEventListener('click', async () => {
        clearError();
        if (!isWalletConnected()) {
          showError('Connect your wallet first using the wallet button.');
          return;
        }
        const walletAddress = getWalletAddress();
        if (!walletAddress) {
          showError('No wallet address found.');
          return;
        }

        try {
          const { message } = await requestWalletNonce(walletAddress);
          const signature = await signAuthMessage(message);
          await walletSignInUser(walletAddress, signature);
          updateAuthUI();
          authDropdown.classList.add('hidden');
          syncAgeTier();
          offerMigrationIfNeeded();
        } catch (e: any) {
          showError(e.body || e.message || 'Wallet sign-in failed');
        }
      });

      // --- Logout ---
      document.getElementById('auth-logout-btn')?.addEventListener('click', async () => {
        await logoutUser();
        updateAuthUI();
        authDropdown.classList.add('hidden');
      });

      // --- Data Migration ---
      async function offerMigrationIfNeeded() {
        if (!isLoggedIn()) return;

        // Check if user has localStorage data worth migrating
        const localInventory = localStorage.getItem('inspired-mile-inventory');
        const localStats = localStorage.getItem('inspired-mile-stats');
        const localAchievements = localStorage.getItem('inspired-mile-achievements');
        if (!localInventory && !localStats && !localAchievements) return;

        try {
          const status = await getMigrationStatus();
          if (status.migrated) return;
        } catch {
          return; // Server unreachable
        }

        document.getElementById('migration-banner')?.classList.remove('hidden');
      }

      document.getElementById('migrate-yes')?.addEventListener('click', async () => {
        const btn = document.getElementById('migrate-yes') as HTMLButtonElement;
        btn.textContent = 'Syncing...';
        btn.disabled = true;

        try {
          const inventory = JSON.parse(localStorage.getItem('inspired-mile-inventory') || '{"cards":[]}');
          const stats = getPlayerStats();
          const achievements = JSON.parse(localStorage.getItem('inspired-mile-achievements') || '[]');
          const variants = JSON.parse(localStorage.getItem('inspired-mile-variants') || '[]');

          const payload: MigrationPayload = {
            cards: (inventory.cards || []).map((c: any) => ({
              card_id: c.cardId || c.card_id,
              acquired_at: c.acquiredAt || null,
              source: c.source || 'migration',
            })),
            stats: {
              battle_wins: stats.battleWins || 0,
              total_battles: stats.totalBattles || 0,
              total_rounds: stats.totalRounds || 0,
              highest_score: stats.highestScore || 0,
              trivia_correct: stats.triviaCorrect || 0,
              trivia_perfect: stats.triviaPerfect || 0,
              challenges_completed: stats.challengesCompleted || 0,
              unique_cards: stats.uniqueCards || 0,
              total_cards: stats.totalCards || 0,
              packs_opened: stats.packsOpened || 0,
            },
            achievements: achievements.map((a: any) => a.id || a),
            variants: variants.map((v: any) => ({
              variant_id: v.variantId || v.variant_id,
              base_card_id: v.baseCardId || v.base_card_id,
              acquired_at: v.acquiredAt || null,
              source: v.source || 'migration',
            })),
          };

          const result = await syncMigration(payload);
          const resultEl = document.getElementById('migration-result')!;
          resultEl.classList.remove('hidden');
          resultEl.classList.add('text-emerald-400');
          resultEl.textContent = `Synced ${result.cards_synced} cards, ${result.achievements_synced} achievements.`;
          setTimeout(() => {
            document.getElementById('migration-banner')?.classList.add('hidden');
          }, 3000);
        } catch (e: any) {
          const resultEl = document.getElementById('migration-result')!;
          resultEl.classList.remove('hidden');
          resultEl.classList.add('text-crimson-400');
          resultEl.textContent = 'Sync failed. You can try again later.';
          btn.textContent = 'Sync Data';
          btn.disabled = false;
        }
      });

      document.getElementById('migrate-no')?.addEventListener('click', () => {
        document.getElementById('migration-banner')?.classList.add('hidden');
      });

      // --- Sync age tier to server ---
      function syncAgeTier() {
        const ageState = localStorage.getItem('inspired-mile-age-verified');
        if (!ageState || !isLoggedIn()) return;
        const tier = ageState === 'adult' ? 'adult' : ageState === 'teen-consented' ? 'teen' : null;
        if (!tier) return;
        // Fire-and-forget
        fetch('/api/v1/credits/age-verify', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ age_tier: tier }),
        }).catch(() => {});
      }

      // --- Init ---
      initStorageBackend().then(() => {
        updateAuthUI();
        initGoogleSignIn();
        syncAgeTier();
      });

      // Re-init Google after GIS script loads (it may load after our script)
      window.addEventListener('load', () => {
        if (!isLoggedIn()) initGoogleSignIn();
      });
    </script>
    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch(() => {});
        });
      }
    </script>
    <!-- Tamper Guard -->
    <script>
      import { initTamperGuard } from '../scripts/tamper-guard';
      initTamperGuard();
    </script>
    <!-- Age Gate -->
    <script is:inline>
      (function() {
        var AGE_KEY = 'inspired-mile-age-verified';
        var stored = localStorage.getItem(AGE_KEY);

        // Skip age gate on legal pages so users can read them
        var legalPages = ['/privacy', '/terms', '/about'];
        if (legalPages.indexOf(window.location.pathname) >= 0) return;

        if (stored === 'adult' || stored === 'teen-consented') return;
        if (stored === 'blocked') {
          // User was under 13 — keep blocking
          document.getElementById('age-gate').classList.remove('hidden');
          document.getElementById('age-gate-form').classList.add('hidden');
          document.getElementById('age-gate-minor').classList.remove('hidden');
          return;
        }

        // Show the age gate
        var gate = document.getElementById('age-gate');
        gate.classList.remove('hidden');

        // Populate day/year dropdowns
        var daySelect = document.getElementById('age-day');
        for (var d = 1; d <= 31; d++) {
          var opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          daySelect.appendChild(opt);
        }

        var yearSelect = document.getElementById('age-year');
        var currentYear = new Date().getFullYear();
        for (var y = currentYear; y >= currentYear - 100; y--) {
          var opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y;
          yearSelect.appendChild(opt);
        }

        // Submit handler
        document.getElementById('age-gate-submit').addEventListener('click', function() {
          var month = parseInt(document.getElementById('age-month').value);
          var day = parseInt(document.getElementById('age-day').value);
          var year = parseInt(document.getElementById('age-year').value);
          var errorEl = document.getElementById('age-gate-error');

          if (!month || !day || !year) {
            errorEl.textContent = 'Please select your full date of birth.';
            errorEl.classList.remove('hidden');
            return;
          }

          var dob = new Date(year, month - 1, day);
          var today = new Date();
          var age = today.getFullYear() - dob.getFullYear();
          var monthDiff = today.getMonth() - dob.getMonth();
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
            age--;
          }

          if (age < 13) {
            // Block access
            localStorage.setItem(AGE_KEY, 'blocked');
            document.getElementById('age-gate-form').classList.add('hidden');
            document.getElementById('age-gate-minor').classList.remove('hidden');
          } else if (age < 18) {
            // Show parental consent
            document.getElementById('age-gate-form').classList.add('hidden');
            document.getElementById('age-gate-teen').classList.remove('hidden');
          } else {
            // Adult — proceed
            localStorage.setItem(AGE_KEY, 'adult');
            gate.classList.add('hidden');
          }
        });

        // Parental consent checkbox
        var checkbox = document.getElementById('parental-consent');
        var teenBtn = document.getElementById('teen-continue');
        if (checkbox && teenBtn) {
          checkbox.addEventListener('change', function() {
            if (checkbox.checked) {
              teenBtn.classList.remove('opacity-50', 'pointer-events-none');
            } else {
              teenBtn.classList.add('opacity-50', 'pointer-events-none');
            }
          });

          teenBtn.addEventListener('click', function() {
            if (checkbox.checked) {
              localStorage.setItem(AGE_KEY, 'teen-consented');
              gate.classList.add('hidden');
            }
          });
        }
      })();
    </script>

    <!-- PWA Install Prompt -->
    <div id="pwa-install-banner" class="fixed bottom-0 left-0 right-0 z-[150] bg-gradient-to-r from-gold-600 to-gold-500 text-obsidian-950 p-3 flex items-center justify-center gap-3 hidden shadow-lg">
      <span class="text-sm font-medium">Install Inspired Mile for the best experience</span>
      <button id="pwa-install-btn" class="px-4 py-1.5 bg-obsidian-900 text-gold-400 rounded-lg text-xs font-bold hover:bg-obsidian-800 transition-colors">Install</button>
      <button id="pwa-dismiss-btn" class="text-obsidian-800 hover:text-obsidian-950 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-banner" class="fixed top-0 left-0 right-0 z-[180] bg-crimson-600 text-white text-center py-2 text-xs font-medium hidden">
      You're offline — Collection and Trivia still work. Multiplayer requires internet.
    </div>

    <script is:inline>
      // PWA Install Prompt
      (function() {
        var deferredPrompt = null;
        var banner = document.getElementById('pwa-install-banner');
        var dismissed = localStorage.getItem('im-install-dismissed');
        if (dismissed) return;

        window.addEventListener('beforeinstallprompt', function(e) {
          e.preventDefault();
          deferredPrompt = e;
          if (window.innerWidth < 768) {
            banner.classList.remove('hidden');
          }
        });

        var installBtn = document.getElementById('pwa-install-btn');
        if (installBtn) {
          installBtn.addEventListener('click', function() {
            if (deferredPrompt) {
              deferredPrompt.prompt();
              deferredPrompt.userChoice.then(function() {
                deferredPrompt = null;
                banner.classList.add('hidden');
              });
            }
          });
        }

        var dismissBtn = document.getElementById('pwa-dismiss-btn');
        if (dismissBtn) {
          dismissBtn.addEventListener('click', function() {
            localStorage.setItem('im-install-dismissed', '1');
            banner.classList.add('hidden');
          });
        }
      })();

      // Offline detection
      (function() {
        var offlineBanner = document.getElementById('offline-banner');
        function updateOnlineStatus() {
          if (navigator.onLine) {
            offlineBanner.classList.add('hidden');
            document.body.style.paddingTop = '';
            document.body.classList.remove('is-offline');
          } else {
            offlineBanner.classList.remove('hidden');
            document.body.style.paddingTop = '32px';
            document.body.classList.add('is-offline');
          }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();
      })();
    </script>
  </body>
</html>
