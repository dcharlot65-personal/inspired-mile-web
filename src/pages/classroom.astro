---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/global.css';
---

<BaseLayout title="Classroom Mode" description="Teachers create classrooms, assign Shakespeare trivia and challenges, and track student progress.">

  <section class="section-padding">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 mb-6">
          <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
          <span class="text-emerald-400 text-xs font-medium tracking-wide uppercase">Education</span>
        </div>
        <h1 class="text-4xl sm:text-5xl font-display font-bold mb-4">
          <span class="text-gradient">Classroom Mode</span>
        </h1>
        <p class="text-obsidian-400 text-lg max-w-2xl mx-auto">
          Create or join a classroom. Teachers assign Shakespeare trivia, challenges, and track student progress.
        </p>
      </div>

      <!-- Consent Gate -->
      <div id="consent-gate" class="card-glass p-6 rounded-2xl mb-8 border-gold-500/20">
        <h3 class="text-lg font-display font-bold text-gold-400 mb-4">Before You Begin</h3>
        <p class="text-sm text-obsidian-400 mb-4">
          Classroom Mode is designed for educational use. Please select your role to continue.
        </p>

        <div class="space-y-3 mb-6">
          <button id="role-teacher" class="w-full card-glass p-4 text-left hover:border-gold-500/30 transition-all flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg bg-gold-500/10 border border-gold-500/20 flex items-center justify-center shrink-0">
              <svg class="w-5 h-5 text-gold-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
            </div>
            <div>
              <p class="text-sm font-semibold text-obsidian-200">I'm a Teacher / Educator</p>
              <p class="text-xs text-obsidian-500">Create and manage classrooms</p>
            </div>
          </button>
          <button id="role-student" class="w-full card-glass p-4 text-left hover:border-emerald-500/30 transition-all flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center shrink-0">
              <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            </div>
            <div>
              <p class="text-sm font-semibold text-obsidian-200">I'm a Student</p>
              <p class="text-xs text-obsidian-500">Join an existing classroom</p>
            </div>
          </button>
        </div>
      </div>

      <!-- Teacher Consent -->
      <div id="teacher-consent" class="card-glass p-6 rounded-2xl mb-8 border-gold-500/20 hidden">
        <h3 class="text-lg font-display font-bold text-gold-400 mb-4">Teacher Verification</h3>
        <div class="space-y-3 mb-4">
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" class="teacher-check mt-1 w-4 h-4 rounded border-obsidian-600 bg-obsidian-800 text-gold-500 focus:ring-gold-500/50" />
            <span class="text-xs text-obsidian-300 leading-relaxed">
              I am an authorized teacher, instructor, or educational administrator.
            </span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" class="teacher-check mt-1 w-4 h-4 rounded border-obsidian-600 bg-obsidian-800 text-gold-500 focus:ring-gold-500/50" />
            <span class="text-xs text-obsidian-300 leading-relaxed">
              I will obtain parental or guardian consent before enrolling any student under 18 years of age.
            </span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" class="teacher-check mt-1 w-4 h-4 rounded border-obsidian-600 bg-obsidian-800 text-gold-500 focus:ring-gold-500/50" />
            <span class="text-xs text-obsidian-300 leading-relaxed">
              I have read and agree to the <a href="/terms" class="text-gold-400 hover:text-gold-300">Terms of Service</a> and <a href="/privacy" class="text-gold-400 hover:text-gold-300">Privacy Policy</a>, including the Classroom &amp; Educational Use and FERPA sections.
            </span>
          </label>
        </div>
        <button id="teacher-continue" class="btn-gold px-6 py-3 rounded-xl font-display font-bold text-sm w-full opacity-50 pointer-events-none">Continue as Teacher</button>
      </div>

      <!-- Student Consent -->
      <div id="student-consent" class="card-glass p-6 rounded-2xl mb-8 border-emerald-500/20 hidden">
        <h3 class="text-lg font-display font-bold text-emerald-400 mb-4">Student Consent</h3>
        <p class="text-sm text-obsidian-400 mb-4">
          Before joining a classroom, please confirm the following:
        </p>
        <div class="space-y-3 mb-4">
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" class="student-check mt-1 w-4 h-4 rounded border-obsidian-600 bg-obsidian-800 text-emerald-500 focus:ring-emerald-500/50" />
            <span class="text-xs text-obsidian-300 leading-relaxed">
              My parent or legal guardian knows I am using Inspired Mile for schoolwork and has given permission.
            </span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" class="student-check mt-1 w-4 h-4 rounded border-obsidian-600 bg-obsidian-800 text-emerald-500 focus:ring-emerald-500/50" />
            <span class="text-xs text-obsidian-300 leading-relaxed">
              I have a join code from my teacher to enter a classroom.
            </span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" class="student-check mt-1 w-4 h-4 rounded border-obsidian-600 bg-obsidian-800 text-emerald-500 focus:ring-emerald-500/50" />
            <span class="text-xs text-obsidian-300 leading-relaxed">
              I understand that my teacher can see my progress and activity in the classroom.
            </span>
          </label>
        </div>
        <button id="student-continue" class="btn-gold px-6 py-3 rounded-xl font-display font-bold text-sm w-full bg-emerald-500 hover:bg-emerald-400 border-emerald-500 opacity-50 pointer-events-none">Continue as Student</button>
      </div>

      <!-- Join / Create Toggle (hidden until consent complete) -->
      <div id="classroom-actions" class="hidden">
      <div class="flex gap-3 justify-center mb-8">
        <button id="btn-join" class="btn-gold px-6 py-3 rounded-xl font-display font-bold text-sm">Join Classroom</button>
        <button id="btn-create" class="btn-outline px-6 py-3 rounded-xl font-display font-bold text-sm">Create Classroom</button>
      </div>
      </div>

      <!-- Join Form -->
      <div id="join-form" class="card-glass p-6 rounded-2xl mb-8 hidden">
        <h3 class="text-lg font-display font-bold text-obsidian-200 mb-4">Join with Code</h3>
        <div class="flex gap-3">
          <input id="join-code" type="text" maxlength="6" placeholder="Enter 6-letter code"
                 class="flex-1 bg-obsidian-800 border border-obsidian-700 rounded-xl px-4 py-3 text-obsidian-200 placeholder-obsidian-500 font-mono text-lg tracking-widest text-center uppercase focus:border-gold-400 focus:outline-none" />
          <button id="join-submit" class="btn-gold px-6 py-3 rounded-xl font-display font-bold">Join</button>
        </div>
        <p id="join-msg" class="text-sm mt-3 text-obsidian-400 hidden"></p>
      </div>

      <!-- Create Form (hidden by default) -->
      <div id="create-form" class="card-glass p-6 rounded-2xl mb-8 hidden">
        <h3 class="text-lg font-display font-bold text-obsidian-200 mb-4">Create a Classroom</h3>
        <div class="flex gap-3">
          <input id="class-name" type="text" maxlength="128" placeholder="Classroom name"
                 class="flex-1 bg-obsidian-800 border border-obsidian-700 rounded-xl px-4 py-3 text-obsidian-200 placeholder-obsidian-500 focus:border-gold-400 focus:outline-none" />
          <button id="create-submit" class="btn-gold px-6 py-3 rounded-xl font-display font-bold">Create</button>
        </div>
        <p id="create-msg" class="text-sm mt-3 text-obsidian-400 hidden"></p>
      </div>

      <!-- My Classrooms -->
      <div id="classrooms-section" class="mb-8">
        <h2 class="text-2xl font-display font-bold text-obsidian-200 mb-6">My Classrooms</h2>
        <div id="classrooms-list" class="space-y-4">
          <!-- skeleton -->
          <div class="card-glass animate-pulse p-6 rounded-2xl">
            <div class="h-5 bg-obsidian-700 rounded w-1/3 mb-3"></div>
            <div class="h-4 bg-obsidian-700 rounded w-1/4"></div>
          </div>
        </div>
        <p id="no-classrooms" class="text-obsidian-500 text-center py-8 hidden">You haven't joined any classrooms yet.</p>
      </div>

      <!-- Classroom Detail (shown when a classroom is selected) -->
      <div id="classroom-detail" class="hidden">
        <div class="flex items-center gap-3 mb-6">
          <button id="back-btn" class="text-obsidian-400 hover:text-gold-400 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          </button>
          <h2 class="text-2xl font-display font-bold text-obsidian-200" id="detail-name"></h2>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Join Code Card -->
          <div class="card-glass p-6 rounded-2xl">
            <h3 class="text-sm font-bold text-obsidian-400 uppercase tracking-wide mb-2">Join Code</h3>
            <p class="text-3xl font-mono tracking-widest text-gold-400" id="detail-code"></p>
            <button id="copy-code" class="mt-3 text-xs text-obsidian-400 hover:text-gold-400 transition-colors">Copy to clipboard</button>
          </div>

          <!-- Members Card -->
          <div class="card-glass p-6 rounded-2xl">
            <h3 class="text-sm font-bold text-obsidian-400 uppercase tracking-wide mb-2">Members</h3>
            <div id="members-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
          </div>
        </div>

        <!-- Assignments (teacher only) -->
        <div id="assignments-section" class="mt-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-display font-bold text-obsidian-200">Assignments</h3>
            <button id="new-assignment" class="btn-gold px-4 py-2 rounded-lg text-xs font-bold hidden">+ New Assignment</button>
          </div>

          <div id="assignment-form" class="card-glass p-4 rounded-xl mb-4 hidden">
            <div class="flex gap-3">
              <input id="assign-title" type="text" maxlength="128" placeholder="Assignment title"
                     class="flex-1 bg-obsidian-800 border border-obsidian-700 rounded-lg px-3 py-2 text-sm text-obsidian-200 placeholder-obsidian-500 focus:border-gold-400 focus:outline-none" />
              <select id="assign-type" class="bg-obsidian-800 border border-obsidian-700 rounded-lg px-3 py-2 text-sm text-obsidian-200 focus:border-gold-400 focus:outline-none">
                <option value="trivia">Trivia</option>
                <option value="challenge">Challenge</option>
                <option value="battle">Battle</option>
              </select>
              <button id="assign-submit" class="btn-gold px-4 py-2 rounded-lg text-xs font-bold">Add</button>
            </div>
          </div>

          <div id="assignments-list" class="space-y-3"></div>
          <p id="no-assignments" class="text-obsidian-500 text-center py-4 hidden">No assignments yet.</p>
        </div>
      </div>
    </div>
  </section>

  <script>
    import { createClassroom, listClassrooms, joinClassroom, listMembers, listAssignments, createAssignment } from '../lib/classroom';
    import type { Classroom } from '../lib/classroom';

    // --- Consent Gate ---
    const CONSENT_KEY = 'inspired-mile-classroom-consent';
    const consentGate = document.getElementById('consent-gate')!;
    const teacherConsent = document.getElementById('teacher-consent')!;
    const studentConsent = document.getElementById('student-consent')!;
    const classroomActions = document.getElementById('classroom-actions')!;

    const storedConsent = localStorage.getItem(CONSENT_KEY);
    if (storedConsent === 'teacher' || storedConsent === 'student') {
      // Already consented â€” show actions directly
      consentGate.classList.add('hidden');
      classroomActions.classList.remove('hidden');
      if (storedConsent === 'student') {
        // Students can only join, not create
        document.getElementById('btn-create')?.classList.add('hidden');
      }
    }

    // Role selection
    document.getElementById('role-teacher')?.addEventListener('click', () => {
      consentGate.classList.add('hidden');
      teacherConsent.classList.remove('hidden');
    });

    document.getElementById('role-student')?.addEventListener('click', () => {
      consentGate.classList.add('hidden');
      studentConsent.classList.remove('hidden');
    });

    // Teacher checkbox logic
    const teacherChecks = document.querySelectorAll('.teacher-check') as NodeListOf<HTMLInputElement>;
    const teacherContinue = document.getElementById('teacher-continue')!;
    teacherChecks.forEach(cb => {
      cb.addEventListener('change', () => {
        const allChecked = Array.from(teacherChecks).every(c => c.checked);
        if (allChecked) {
          teacherContinue.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          teacherContinue.classList.add('opacity-50', 'pointer-events-none');
        }
      });
    });
    teacherContinue.addEventListener('click', () => {
      localStorage.setItem(CONSENT_KEY, 'teacher');
      teacherConsent.classList.add('hidden');
      classroomActions.classList.remove('hidden');
    });

    // Student checkbox logic
    const studentChecks = document.querySelectorAll('.student-check') as NodeListOf<HTMLInputElement>;
    const studentContinue = document.getElementById('student-continue')!;
    studentChecks.forEach(cb => {
      cb.addEventListener('change', () => {
        const allChecked = Array.from(studentChecks).every(c => c.checked);
        if (allChecked) {
          studentContinue.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          studentContinue.classList.add('opacity-50', 'pointer-events-none');
        }
      });
    });
    studentContinue.addEventListener('click', () => {
      localStorage.setItem(CONSENT_KEY, 'student');
      studentConsent.classList.add('hidden');
      classroomActions.classList.remove('hidden');
      // Students can only join
      document.getElementById('btn-create')?.classList.add('hidden');
    });

    // --- Classroom UI ---
    const joinForm = document.getElementById('join-form')!;
    const createForm = document.getElementById('create-form')!;
    const btnJoin = document.getElementById('btn-join')!;
    const btnCreate = document.getElementById('btn-create')!;
    const classroomsList = document.getElementById('classrooms-list')!;
    const noClassrooms = document.getElementById('no-classrooms')!;
    const classroomsSection = document.getElementById('classrooms-section')!;
    const classroomDetail = document.getElementById('classroom-detail')!;

    let currentClassrooms: Classroom[] = [];

    // Toggle join/create forms
    btnJoin?.addEventListener('click', () => {
      joinForm.classList.remove('hidden');
      createForm.classList.add('hidden');
      btnJoin.className = 'btn-gold px-6 py-3 rounded-xl font-display font-bold text-sm';
      if (btnCreate) btnCreate.className = 'btn-outline px-6 py-3 rounded-xl font-display font-bold text-sm';
    });

    btnCreate?.addEventListener('click', () => {
      createForm.classList.remove('hidden');
      joinForm.classList.add('hidden');
      btnCreate.className = 'btn-gold px-6 py-3 rounded-xl font-display font-bold text-sm';
      btnJoin.className = 'btn-outline px-6 py-3 rounded-xl font-display font-bold text-sm';
    });

    // Auto-show join form for students who completed consent
    if (storedConsent === 'student') {
      joinForm.classList.remove('hidden');
    }

    // Join classroom
    document.getElementById('join-submit')!.addEventListener('click', async () => {
      const code = (document.getElementById('join-code') as HTMLInputElement).value.trim();
      const msg = document.getElementById('join-msg')!;
      if (!code || code.length !== 6) {
        msg.textContent = 'Please enter a 6-letter join code.';
        msg.className = 'text-sm mt-3 text-red-400';
        return;
      }
      try {
        const result = await joinClassroom(code);
        msg.textContent = `Joined "${result.classroom}" successfully!`;
        msg.className = 'text-sm mt-3 text-emerald-400';
        loadClassrooms();
      } catch (e: any) {
        msg.textContent = e.message || 'Failed to join';
        msg.className = 'text-sm mt-3 text-red-400';
      }
    });

    // Create classroom
    document.getElementById('create-submit')!.addEventListener('click', async () => {
      const name = (document.getElementById('class-name') as HTMLInputElement).value.trim();
      const msg = document.getElementById('create-msg')!;
      if (!name) {
        msg.textContent = 'Please enter a classroom name.';
        msg.className = 'text-sm mt-3 text-red-400';
        return;
      }
      try {
        await createClassroom(name);
        msg.textContent = 'Classroom created!';
        msg.className = 'text-sm mt-3 text-emerald-400';
        (document.getElementById('class-name') as HTMLInputElement).value = '';
        loadClassrooms();
      } catch (e: any) {
        msg.textContent = e.message || 'Failed to create';
        msg.className = 'text-sm mt-3 text-red-400';
      }
    });

    // Back button
    document.getElementById('back-btn')!.addEventListener('click', () => {
      classroomDetail.classList.add('hidden');
      classroomsSection.classList.remove('hidden');
    });

    // Load classrooms
    async function loadClassrooms() {
      try {
        currentClassrooms = await listClassrooms();
        if (currentClassrooms.length === 0) {
          classroomsList.innerHTML = '';
          noClassrooms.classList.remove('hidden');
          return;
        }
        noClassrooms.classList.add('hidden');
        classroomsList.innerHTML = currentClassrooms.map(c => `
          <button class="card-glass p-5 rounded-2xl w-full text-left hover:border-gold-400/30 transition-colors" data-id="${c.id}">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-display font-bold text-obsidian-200">${c.name}</h3>
                <p class="text-xs text-obsidian-500 mt-1">${c.member_count} member${c.member_count !== 1 ? 's' : ''} &middot; Code: <span class="font-mono text-gold-400">${c.join_code}</span></p>
              </div>
              <svg class="w-5 h-5 text-obsidian-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
          </button>
        `).join('');

        // Click handlers
        classroomsList.querySelectorAll('[data-id]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id')!);
            openClassroom(id);
          });
        });
      } catch {
        classroomsList.innerHTML = '<p class="text-obsidian-500 text-center py-4">Sign in to view your classrooms.</p>';
      }
    }

    async function openClassroom(id: number) {
      const classroom = currentClassrooms.find(c => c.id === id);
      if (!classroom) return;

      classroomsSection.classList.add('hidden');
      classroomDetail.classList.remove('hidden');

      document.getElementById('detail-name')!.textContent = classroom.name;
      document.getElementById('detail-code')!.textContent = classroom.join_code;

      // Copy code
      document.getElementById('copy-code')!.onclick = async () => {
        await navigator.clipboard.writeText(classroom.join_code);
        document.getElementById('copy-code')!.textContent = 'Copied!';
        setTimeout(() => { document.getElementById('copy-code')!.textContent = 'Copy to clipboard'; }, 2000);
      };

      // Load members
      try {
        const members = await listMembers(id);
        const membersList = document.getElementById('members-list')!;
        membersList.innerHTML = members.map(m => `
          <div class="flex items-center justify-between text-sm">
            <span class="text-obsidian-200">${m.username}</span>
            <span class="text-xs px-2 py-0.5 rounded-full ${m.role === 'teacher' ? 'bg-gold-400/10 text-gold-400' : 'bg-obsidian-700 text-obsidian-400'}">${m.role}</span>
          </div>
        `).join('');

        // Show teacher controls
        const isTeacher = members.some(m => m.role === 'teacher');
        const newBtn = document.getElementById('new-assignment')!;
        if (isTeacher) {
          newBtn.classList.remove('hidden');
          newBtn.onclick = () => document.getElementById('assignment-form')!.classList.toggle('hidden');
        }
      } catch { /* not logged in */ }

      // Load assignments
      try {
        const assignments = await listAssignments(id);
        const list = document.getElementById('assignments-list')!;
        const noA = document.getElementById('no-assignments')!;
        if (assignments.length === 0) {
          list.innerHTML = '';
          noA.classList.remove('hidden');
        } else {
          noA.classList.add('hidden');
          list.innerHTML = assignments.map(a => `
            <div class="card-glass p-4 rounded-xl flex items-center justify-between">
              <div>
                <p class="font-display font-bold text-obsidian-200 text-sm">${a.title}</p>
                <p class="text-xs text-obsidian-500">${a.assignment_type} &middot; ${new Date(a.created_at).toLocaleDateString()}</p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-400 capitalize">${a.assignment_type}</span>
            </div>
          `).join('');
        }
      } catch { /* */ }

      // Assignment submit
      document.getElementById('assign-submit')!.onclick = async () => {
        const title = (document.getElementById('assign-title') as HTMLInputElement).value.trim();
        const type = (document.getElementById('assign-type') as HTMLSelectElement).value;
        if (!title) return;
        try {
          await createAssignment(id, title, type);
          (document.getElementById('assign-title') as HTMLInputElement).value = '';
          document.getElementById('assignment-form')!.classList.add('hidden');
          openClassroom(id); // refresh
        } catch { /* */ }
      };
    }

    loadClassrooms();
  </script>

</BaseLayout>
