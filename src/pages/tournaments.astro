---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/global.css';
---

<BaseLayout title="Tournaments" description="Compete in Shakespearean rap battle tournaments for glory and prizes.">

  <section class="section-padding">
    <div class="max-w-6xl mx-auto">
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gold-500/10 border border-gold-500/20 mb-6">
          <span class="w-2 h-2 rounded-full bg-gold-500 animate-pulse"></span>
          <span class="text-gold-400 text-xs font-medium tracking-wide uppercase">Tournaments</span>
        </div>
        <h1 class="text-4xl sm:text-5xl font-display font-bold mb-4">
          Tournament <span class="text-gradient">Arena</span>
        </h1>
        <p class="text-obsidian-400 max-w-2xl mx-auto">
          Enter organized competitions and prove your Shakespearean rap mastery. Single elimination, round robin, and more.
        </p>
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 mb-8 justify-center">
        <button id="tab-list" class="px-6 py-2 text-sm font-medium rounded-lg bg-gold-500/10 text-gold-400 border border-gold-500/20 transition-colors">
          Tournaments
        </button>
        <button id="tab-bracket" class="px-6 py-2 text-sm font-medium rounded-lg text-obsidian-400 border border-obsidian-700 hover:border-obsidian-600 transition-colors">
          Bracket View
        </button>
      </div>

      <!-- Tournament List -->
      <div id="panel-list">
        <div id="tournament-list" class="space-y-4">
          <div class="text-center py-12">
            <div class="w-6 h-6 border-2 border-gold-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
            <p class="text-sm text-obsidian-500">Loading tournaments...</p>
          </div>
        </div>
      </div>

      <!-- Bracket View -->
      <div id="panel-bracket" class="hidden">
        <div class="mb-6">
          <select id="bracket-tournament-select" class="bg-obsidian-800 border border-obsidian-700 rounded-lg px-4 py-2 text-sm text-obsidian-200 focus:outline-none focus:border-gold-500/50">
            <option value="">Select a tournament...</option>
          </select>
        </div>

        <div id="bracket-container" class="overflow-x-auto">
          <div class="text-center py-12">
            <p class="text-sm text-obsidian-500">Select a tournament to view its bracket.</p>
          </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard-section" class="hidden mt-8">
          <h2 class="font-display text-xl font-bold text-obsidian-200 mb-4">Leaderboard</h2>
          <div id="leaderboard-table" class="card-glass overflow-hidden">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    import { listTournaments, getTournament, registerForTournament, getBracket, getLeaderboard, type Tournament, type BracketMatch, type LeaderboardEntry } from '../lib/tournament-client';
    import { isLoggedIn } from '../lib/storage-backend';

    // Tabs
    const tabPairs = [['list', 'panel-list'], ['bracket', 'panel-bracket']] as const;
    tabPairs.forEach(([tab, panel]) => {
      document.getElementById(`tab-${tab}`)!.addEventListener('click', () => {
        tabPairs.forEach(([t, p]) => {
          document.getElementById(p)!.classList.toggle('hidden', t !== tab);
          const btn = document.getElementById(`tab-${t}`)!;
          if (t === tab) {
            btn.className = 'px-6 py-2 text-sm font-medium rounded-lg bg-gold-500/10 text-gold-400 border border-gold-500/20 transition-colors';
          } else {
            btn.className = 'px-6 py-2 text-sm font-medium rounded-lg text-obsidian-400 border border-obsidian-700 hover:border-obsidian-600 transition-colors';
          }
        });
      });
    });

    // Status colors
    function statusColor(status: string): string {
      switch (status) {
        case 'registration': return 'text-emerald-400 bg-emerald-500/10';
        case 'in_progress': return 'text-purple-400 bg-purple-500/10';
        case 'completed': return 'text-obsidian-400 bg-obsidian-800';
        default: return 'text-obsidian-400 bg-obsidian-800';
      }
    }

    // Load tournament list
    const listContainer = document.getElementById('tournament-list')!;
    const bracketSelect = document.getElementById('bracket-tournament-select') as HTMLSelectElement;
    let tournaments: Tournament[] = [];

    async function loadTournaments() {
      try {
        tournaments = await listTournaments();
        renderTournaments();
        populateBracketSelect();
      } catch (e: any) {
        const isOffline = !e.message || e.message.includes('Failed to fetch') || e.message.includes('NetworkError');
        listContainer.innerHTML = isOffline
          ? '<div class="text-center py-12"><div class="w-16 h-16 rounded-full bg-obsidian-800 border border-obsidian-700 flex items-center justify-center mx-auto mb-4"><span class="text-2xl">&#127942;</span></div><p class="text-sm text-obsidian-300 font-display font-bold mb-2">Tournaments Coming Soon</p><p class="text-xs text-obsidian-500">The backend service is being set up. Check back shortly.</p></div>'
          : '<div class="text-center py-12"><p class="text-sm text-crimson-400">Failed to load tournaments.</p></div>';
      }
    }

    function renderTournaments() {
      if (tournaments.length === 0) {
        listContainer.innerHTML = '<div class="text-center py-12"><p class="text-sm text-obsidian-500">No tournaments available yet. Check back soon!</p></div>';
        return;
      }

      listContainer.innerHTML = tournaments.map(t => {
        const startsAt = new Date(t.starts_at);
        const isOpen = t.status === 'registration';
        const entryCount = t.entry_count ?? 0;

        return `
          <div class="card-glass p-6 hover:border-gold-500/30 transition-colors">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="font-display text-lg font-bold text-obsidian-200">${t.name}</h3>
                  <span class="text-xs font-mono ${statusColor(t.status)} px-2 py-0.5 rounded-full uppercase">
                    ${t.status.replace('_', ' ')}
                  </span>
                </div>
                <div class="flex flex-wrap gap-4 text-xs text-obsidian-400">
                  <span>Format: <span class="text-obsidian-300">${t.format.replace('_', ' ')}</span></span>
                  <span>Players: <span class="text-obsidian-300">${entryCount} / ${t.max_players}</span></span>
                  <span>Starts: <span class="text-obsidian-300">${startsAt.toLocaleDateString()} ${startsAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span></span>
                </div>
              </div>
              <div class="flex gap-2">
                ${isOpen ? `<button class="register-btn btn-primary text-xs px-4 py-2" data-id="${t.id}">Register</button>` : ''}
                <button class="view-bracket-btn text-xs text-obsidian-400 hover:text-gold-400 border border-obsidian-700 rounded-lg px-4 py-2 transition-colors" data-id="${t.id}">
                  View Bracket
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Register buttons
      listContainer.querySelectorAll('.register-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!isLoggedIn()) { (window as any).showToast('Sign in to register.', 'warning'); return; }
          const id = (btn as HTMLElement).dataset.id!;
          try {
            await registerForTournament(id);
            (window as any).showToast('Registered successfully!', 'success');
            loadTournaments();
          } catch (e: any) {
            (window as any).showToast(e.message || 'Registration failed', 'error');
          }
        });
      });

      // View bracket buttons
      listContainer.querySelectorAll('.view-bracket-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = (btn as HTMLElement).dataset.id!;
          bracketSelect.value = id;
          document.getElementById('tab-bracket')!.click();
          loadBracket(id);
        });
      });
    }

    function populateBracketSelect() {
      // Clear existing options except the placeholder
      while (bracketSelect.options.length > 1) bracketSelect.remove(1);
      tournaments.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.name} (${t.status})`;
        bracketSelect.appendChild(opt);
      });
    }

    // Bracket view
    const bracketContainer = document.getElementById('bracket-container')!;
    const leaderboardSection = document.getElementById('leaderboard-section')!;
    const leaderboardTable = document.getElementById('leaderboard-table')!;

    bracketSelect.addEventListener('change', () => {
      if (bracketSelect.value) loadBracket(bracketSelect.value);
    });

    async function loadBracket(tournamentId: string) {
      bracketContainer.innerHTML = '<div class="text-center py-12"><div class="w-6 h-6 border-2 border-gold-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div><p class="text-sm text-obsidian-500">Loading bracket...</p></div>';

      try {
        const matches = await getBracket(tournamentId);
        renderBracket(matches);
        loadLeaderboard(tournamentId);
      } catch {
        bracketContainer.innerHTML = '<div class="text-center py-12"><p class="text-sm text-obsidian-500">No bracket available yet.</p></div>';
      }
    }

    function renderBracket(matches: BracketMatch[]) {
      if (matches.length === 0) {
        bracketContainer.innerHTML = '<div class="text-center py-12"><p class="text-sm text-obsidian-500">Bracket not yet generated.</p></div>';
        return;
      }

      // Group by round
      const rounds = new Map<number, BracketMatch[]>();
      matches.forEach(m => {
        if (!rounds.has(m.round)) rounds.set(m.round, []);
        rounds.get(m.round)!.push(m);
      });

      const sortedRounds = [...rounds.entries()].sort((a, b) => a[0] - b[0]);

      bracketContainer.innerHTML = `
        <div class="flex gap-6 min-w-max py-4">
          ${sortedRounds.map(([roundNum, roundMatches]) => `
            <div class="flex flex-col gap-4 min-w-[220px]">
              <div class="text-center text-xs font-mono text-obsidian-500 uppercase tracking-wider mb-2">
                Round ${roundNum}
              </div>
              ${roundMatches.sort((a, b) => a.match_order - b.match_order).map(m => {
                const p1 = m.player1_name || 'BYE';
                const p2 = m.player2_name || 'BYE';
                const p1Won = m.winner_id && m.winner_id === m.player1_id;
                const p2Won = m.winner_id && m.winner_id === m.player2_id;
                const pending = m.status === 'pending';

                return `
                  <div class="card-glass p-3 ${m.status === 'in_progress' ? 'border-purple-500/30' : ''}">
                    <div class="flex items-center justify-between py-1 ${p1Won ? 'text-gold-400 font-semibold' : 'text-obsidian-300'} text-sm">
                      <span>${p1}</span>
                      ${p1Won ? '<span class="text-xs">&#9733;</span>' : ''}
                    </div>
                    <div class="border-t border-obsidian-700/50 my-1"></div>
                    <div class="flex items-center justify-between py-1 ${p2Won ? 'text-gold-400 font-semibold' : 'text-obsidian-300'} text-sm">
                      <span>${p2}</span>
                      ${p2Won ? '<span class="text-xs">&#9733;</span>' : ''}
                    </div>
                    <div class="text-center mt-1">
                      <span class="text-[10px] font-mono ${m.status === 'in_progress' ? 'text-purple-400' : m.status === 'completed' ? 'text-obsidian-500' : 'text-obsidian-600'}">
                        ${m.status === 'in_progress' ? 'LIVE' : m.status === 'completed' ? 'DONE' : 'PENDING'}
                      </span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `).join('')}
        </div>
      `;
    }

    async function loadLeaderboard(tournamentId: string) {
      try {
        const entries = await getLeaderboard(tournamentId);
        if (entries.length === 0) {
          leaderboardSection.classList.add('hidden');
          return;
        }

        leaderboardSection.classList.remove('hidden');
        leaderboardTable.innerHTML = `
          <table class="w-full text-sm">
            <thead>
              <tr class="text-xs text-obsidian-500 uppercase tracking-wider border-b border-obsidian-700/50">
                <th class="text-left px-4 py-3">#</th>
                <th class="text-left px-4 py-3">Player</th>
                <th class="text-center px-4 py-3">W</th>
                <th class="text-center px-4 py-3">L</th>
                <th class="text-center px-4 py-3">Status</th>
              </tr>
            </thead>
            <tbody>
              ${entries.sort((a, b) => b.wins - a.wins || a.losses - b.losses).map((e, i) => `
                <tr class="border-b border-obsidian-800/50 ${e.eliminated ? 'opacity-50' : ''}">
                  <td class="px-4 py-3 text-obsidian-500 font-mono">${i + 1}</td>
                  <td class="px-4 py-3 text-obsidian-200 font-medium">${e.username}</td>
                  <td class="px-4 py-3 text-center text-emerald-400">${e.wins}</td>
                  <td class="px-4 py-3 text-center text-crimson-400">${e.losses}</td>
                  <td class="px-4 py-3 text-center">
                    <span class="text-xs ${e.eliminated ? 'text-crimson-400' : 'text-emerald-400'}">
                      ${e.eliminated ? 'Eliminated' : 'Active'}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch {
        leaderboardSection.classList.add('hidden');
      }
    }

    // Init
    loadTournaments();
  </script>
</BaseLayout>
